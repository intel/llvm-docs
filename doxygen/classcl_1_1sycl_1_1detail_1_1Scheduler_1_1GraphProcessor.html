<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPC++ Runtime: cl::sycl::detail::Scheduler::GraphProcessor Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DPC++ Runtime
   </div>
   <div id="projectbrief">Runtime libraries for oneAPI Data Parallel C++</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">cl::sycl::detail::Scheduler::GraphProcessor Class Reference<div class="ingroups"><a class="el" href="group__sycl__graph.html">DPC++ Execution Graph</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Graph Processor provides interfaces for enqueueing commands and their dependencies to the underlying runtime.  
 <a href="classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="scheduler_8hpp_source.html">detail/scheduler/scheduler.hpp</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a666923c37e06ca4f54b6eb74f0ad72db"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor.html#a666923c37e06ca4f54b6eb74f0ad72db">waitForEvent</a> (<a class="el" href="namespacecl_1_1sycl_1_1detail.html#ae666f00e7fc733aa20add2a77a262c9c">EventImplPtr</a> Event, <a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler.html#a011d40c491f07a7097b8b77431c50f54">ReadLockT</a> &amp;GraphReadLock, std::vector&lt; <a class="el" href="classcl_1_1sycl_1_1detail_1_1Command.html">Command</a> * &gt; &amp;ToCleanUp, bool LockTheLock=true)</td></tr>
<tr class="memdesc:a666923c37e06ca4f54b6eb74f0ad72db"><td class="mdescLeft">&#160;</td><td class="mdescRight">Waits for the command, associated with Event passed, is completed.  <a href="classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor.html#a666923c37e06ca4f54b6eb74f0ad72db">More...</a><br /></td></tr>
<tr class="separator:a666923c37e06ca4f54b6eb74f0ad72db"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab3e3bcb3638b614c23e42e09c915b4f2"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor.html#ab3e3bcb3638b614c23e42e09c915b4f2">enqueueCommand</a> (<a class="el" href="classcl_1_1sycl_1_1detail_1_1Command.html">Command</a> *Cmd, <a class="el" href="structcl_1_1sycl_1_1detail_1_1EnqueueResultT.html">EnqueueResultT</a> &amp;EnqueueResult, std::vector&lt; <a class="el" href="classcl_1_1sycl_1_1detail_1_1Command.html">Command</a> * &gt; &amp;ToCleanUp, <a class="el" href="namespacecl_1_1sycl_1_1detail.html#af961fb0fe94eef91c4feb0abf6239819">BlockingT</a> Blocking=<a class="el" href="namespacecl_1_1sycl_1_1detail.html#af961fb0fe94eef91c4feb0abf6239819aa95cce2be00376fe3e3b164f1f511e41">NON_BLOCKING</a>)</td></tr>
<tr class="memdesc:ab3e3bcb3638b614c23e42e09c915b4f2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enqueues the command and all its dependencies.  <a href="classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor.html#ab3e3bcb3638b614c23e42e09c915b4f2">More...</a><br /></td></tr>
<tr class="separator:ab3e3bcb3638b614c23e42e09c915b4f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Graph Processor provides interfaces for enqueueing commands and their dependencies to the underlying runtime. </p>
<p>Member functions of this class do not modify the graph.</p>
<h1><a class="anchor" id="sched_enqueue"></a>
Command enqueueing</h1>
<p>Commands are enqueued whenever they come to the <a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler.html" title="DPC++ graph scheduler class.">Scheduler</a>. Each command has enqueue method which takes vector of events that represents dependencies and returns event which represents the command. <a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor.html" title="Graph Processor provides interfaces for enqueueing commands and their dependencies to the underlying ...">GraphProcessor</a> performs topological sort to get the order in which commands have to be enqueued. Then it enqueues each command, passing a vector of events that this command needs to wait on. If an error happens during command enqueue, the whole process is stopped, the faulty command is propagated back to the <a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler.html" title="DPC++ graph scheduler class.">Scheduler</a>.</p>
<p>The command with dependencies that belong to a context different from its own can't be enqueued directly (limitation of OpenCL runtime). Instead, for each dependency, a proxy event is created in the target context and linked using OpenCL callback mechanism with original one. For example, the following SYCL code:</p>
<div class="fragment"><div class="line"><span class="comment">// The ContextA and ContextB are different OpenCL contexts</span></div>
<div class="line"><a class="code" href="namespacecl_1_1sycl_1_1info.html#a298d56c26b4eec2a4d4fb1649e2d1063">sycl::queue</a> Q1(ContextA);</div>
<div class="line"><a class="code" href="namespacecl_1_1sycl_1_1info.html#a298d56c26b4eec2a4d4fb1649e2d1063">sycl::queue</a> Q2(ContextB);</div>
<div class="line"> </div>
<div class="line">Q1.submit(Task1);</div>
<div class="line"> </div>
<div class="line">Q2.submit(Task2);</div>
</div><!-- fragment --><p>is translated to the following OCL API calls:</p>
<div class="fragment"><div class="line"> <span class="keywordtype">void</span> event_completion_callback(<span class="keywordtype">void</span> *data) {</div>
<div class="line">   <span class="comment">// Change status of event to complete.</span></div>
<div class="line">   clSetEventStatus((cl_event *)data, CL_COMPLETE); <span class="comment">// Scope of Context2</span></div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Enqueue TASK1</span></div>
<div class="line">EventTask1 = clEnqueueNDRangeKernel(Q1, TASK1, ..); <span class="comment">// Scope of Context1</span></div>
<div class="line"><span class="comment">// Read memory to host</span></div>
<div class="line">ReadMem = clEnqueueReadBuffer(A, .., <span class="comment">/*Deps=*/</span>EventTask1); <span class="comment">// Scope of</span></div>
<div class="line"><span class="comment">// Context1</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create user event with initial status &quot;not completed&quot;.</span></div>
<div class="line">UserEvent = clCreateUserEvent(Context2); <span class="comment">// Scope of Context2</span></div>
<div class="line"><span class="comment">// Ask OpenCL to call callback with UserEvent as data when &quot;read memory</span></div>
<div class="line"><span class="comment">// to host&quot; operation is completed</span></div>
<div class="line">clSetEventCallback(ReadMem, event_completion_callback,</div>
<div class="line">                   <span class="comment">/*data=*/</span>UserEvent); <span class="comment">// Scope of Context1</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Enqueue write memory from host, block it on user event</span></div>
<div class="line"><span class="comment">// It will be unblocked when we change UserEvent status to completed in</span></div>
<div class="line"><span class="comment">// callback.</span></div>
<div class="line">WriteMem =</div>
<div class="line">   clEnqueueWriteBuffer(A, .., <span class="comment">/*Dep=*/</span>UserEvent); <span class="comment">// Scope of Context2</span></div>
<div class="line"><span class="comment">// Enqueue TASK2</span></div>
<div class="line">EventTask2 =</div>
<div class="line">   clEnqueueNDRangeKernel(TASK, .., <span class="comment">/*Dep=*/</span>WriteMem); <span class="comment">// Scope of</span></div>
<div class="line">   <span class="comment">// Context2</span></div>
</div><!-- fragment --><p>The alternative approach that has been considered is to have separate dispatcher thread that would wait for all events from the Context other then target Context to complete and then enqueue command with dependencies from target Context only. Alternative approach makes code significantly more complex and can hurt performance on CPU device vs chosen approach with callbacks. </p>

<p class="definition">Definition at line <a class="el" href="scheduler_8hpp_source.html#l00731">731</a> of file <a class="el" href="scheduler_8hpp_source.html">scheduler.hpp</a>.</p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a id="ab3e3bcb3638b614c23e42e09c915b4f2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab3e3bcb3638b614c23e42e09c915b4f2">&#9670;&nbsp;</a></span>enqueueCommand()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool cl::sycl::detail::Scheduler::GraphProcessor::enqueueCommand </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classcl_1_1sycl_1_1detail_1_1Command.html">Command</a> *&#160;</td>
          <td class="paramname"><em>Cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structcl_1_1sycl_1_1detail_1_1EnqueueResultT.html">EnqueueResultT</a> &amp;&#160;</td>
          <td class="paramname"><em>EnqueueResult</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="classcl_1_1sycl_1_1detail_1_1Command.html">Command</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>ToCleanUp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="namespacecl_1_1sycl_1_1detail.html#af961fb0fe94eef91c4feb0abf6239819">BlockingT</a>&#160;</td>
          <td class="paramname"><em>Blocking</em> = <code><a class="el" href="namespacecl_1_1sycl_1_1detail.html#af961fb0fe94eef91c4feb0abf6239819aa95cce2be00376fe3e3b164f1f511e41">NON_BLOCKING</a></code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Enqueues the command and all its dependencies. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">EnqueueResult</td><td>is set to specific status if enqueue failed. </td></tr>
    <tr><td class="paramname">ToCleanUp</td><td>container for commands that can be cleaned up. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>true if the command is successfully enqueued.</dd></dl>
<p>The function may unlock and lock GraphReadLock as needed. Upon return the lock is left in locked state. </p>

<p class="definition">Definition at line <a class="el" href="graph__processor_8cpp_source.html#l00049">49</a> of file <a class="el" href="graph__processor_8cpp_source.html">graph_processor.cpp</a>.</p>

<p class="reference">References <a class="el" href="commands_8cpp_source.html#l00660">cl::sycl::detail::Command::enqueue()</a>, <a class="el" href="commands_8hpp_source.html#l00251">cl::sycl::detail::Command::getPreparedHostDepsEvents()</a>, <a class="el" href="commands_8hpp_source.html#l00145">cl::sycl::detail::Command::isEnqueueBlocked()</a>, <a class="el" href="commands_8hpp_source.html#l00141">cl::sycl::detail::Command::isSuccessfullyEnqueued()</a>, <a class="el" href="commands_8hpp_source.html#l00080">cl::sycl::detail::DepDesc::MDepCommand</a>, and <a class="el" href="commands_8hpp_source.html#l00256">cl::sycl::detail::Command::MDeps</a>.</p>

</div>
</div>
<a id="a666923c37e06ca4f54b6eb74f0ad72db"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a666923c37e06ca4f54b6eb74f0ad72db">&#9670;&nbsp;</a></span>waitForEvent()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void cl::sycl::detail::Scheduler::GraphProcessor::waitForEvent </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="namespacecl_1_1sycl_1_1detail.html#ae666f00e7fc733aa20add2a77a262c9c">EventImplPtr</a>&#160;</td>
          <td class="paramname"><em>Event</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler.html#a011d40c491f07a7097b8b77431c50f54">ReadLockT</a> &amp;&#160;</td>
          <td class="paramname"><em>GraphReadLock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="classcl_1_1sycl_1_1detail_1_1Command.html">Command</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>ToCleanUp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>LockTheLock</em> = <code>true</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Waits for the command, associated with Event passed, is completed. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">GraphReadLock</td><td>read-lock which is already acquired for reading </td></tr>
    <tr><td class="paramname">ToCleanUp</td><td>container for commands that can be cleaned up. </td></tr>
    <tr><td class="paramname">LockTheLock</td><td>selects if graph lock should be locked upon return</td></tr>
  </table>
  </dd>
</dl>
<p>The function may unlock and lock GraphReadLock as needed. Upon return the lock is left in locked state if and only if LockTheLock is true. </p>

<p class="definition">Definition at line <a class="el" href="graph__processor_8cpp_source.html#l00024">24</a> of file <a class="el" href="graph__processor_8cpp_source.html">graph_processor.cpp</a>.</p>

<p class="reference">References <a class="el" href="commands_8hpp_source.html#l00047">cl::sycl::detail::BLOCKING</a>, <a class="el" href="graph__processor_8cpp_source.html#l00020">cl::sycl::detail::getCommand()</a>, <a class="el" href="commands_8hpp_source.html#l00153">cl::sycl::detail::Command::getEvent()</a>, <a class="el" href="commands_8hpp_source.html#l00061">cl::sycl::detail::EnqueueResultT::MResult</a>, and <a class="el" href="pi_8h_source.html#l00085">PI_INVALID_OPERATION</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>source/detail/scheduler/<a class="el" href="scheduler_8hpp_source.html">scheduler.hpp</a></li>
<li>source/detail/scheduler/<a class="el" href="graph__processor_8cpp_source.html">graph_processor.cpp</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="anamespacecl_1_1sycl_1_1info_html_a298d56c26b4eec2a4d4fb1649e2d1063"><div class="ttname"><a href="namespacecl_1_1sycl_1_1info.html#a298d56c26b4eec2a4d4fb1649e2d1063">cl::sycl::info::queue</a></div><div class="ttdeci">queue</div><div class="ttdef"><b>Definition:</b> <a href="info__desc_8hpp_source.html#l00229">info_desc.hpp:229</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacecl.html">cl</a></li><li class="navelem"><a class="el" href="namespacecl_1_1sycl.html">sycl</a></li><li class="navelem"><a class="el" href="namespacecl_1_1sycl_1_1detail.html">detail</a></li><li class="navelem"><a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler.html">Scheduler</a></li><li class="navelem"><a class="el" href="classcl_1_1sycl_1_1detail_1_1Scheduler_1_1GraphProcessor.html">GraphProcessor</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
