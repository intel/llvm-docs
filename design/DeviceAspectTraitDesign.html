<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Implementation design for sycl::any_device_has and sycl::all_devices_have &#8212; oneAPI DPC++ Compiler  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=e491ac2d" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Implementation Design for Device Configuration File" href="DeviceConfigFile.html" />
    <link rel="prev" title="Non-Relocatable Device Code" href="NonRelocatableDeviceCode.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>oneAPI DPC++ Compiler  documentation</span></a></h1>
        <h2 class="heading"><span>Implementation design for sycl::any_device_has and sycl::all_devices_have</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="NonRelocatableDeviceCode.html">Non-Relocatable Device Code</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="DeviceConfigFile.html">Implementation Design for Device Configuration File</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="implementation-design-for-sycl-any-device-has-and-sycl-all-devices-have">
<h1>Implementation design for <code class="docutils literal notranslate"><span class="pre">sycl::any_device_has</span></code> and <code class="docutils literal notranslate"><span class="pre">sycl::all_devices_have</span></code><a class="headerlink" href="#implementation-design-for-sycl-any-device-has-and-sycl-all-devices-have" title="Link to this heading">¶</a></h1>
<p>This design document describes the implementation of the SYCL 2020 device aspect
traits <code class="docutils literal notranslate"><span class="pre">any_device_has</span></code> and <code class="docutils literal notranslate"><span class="pre">all_devices_have</span></code> as described in the
<a class="reference external" href="https://registry.khronos.org/SYCL/specs/sycl-2020/html/sycl-2020.html#sec:device-aspects">SYCL 2020 Specification Rev. 6 Section 4.6.4.3</a>.</p>
<p>In summary, <code class="docutils literal notranslate"><span class="pre">any_device_has&lt;aspect&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">all_devices_have&lt;aspect&gt;</span></code> must inherit
from either <code class="docutils literal notranslate"><span class="pre">std::true_type</span></code> or <code class="docutils literal notranslate"><span class="pre">std::false_type</span></code> depending on whether the
corresponding compilation environment can guarantee that any and all the
supported devices support the <code class="docutils literal notranslate"><span class="pre">aspect</span></code>.</p>
<p>The design of these traits is inspired by the implementation of the
<a class="reference download internal" download="" href="../_downloads/ff081d9da16b0e716ce1b7787452a6a3/sycl_ext_oneapi_device_if.asciidoc"><span class="xref download myst">sycl_ext_oneapi_device_if</span></a> and
<a class="reference download internal" download="" href="../_downloads/29eec7da90e760d8eaf2283a50ff5ea3/sycl_ext_oneapi_device_architecture.asciidoc"><span class="xref download myst">sycl_ext_oneapi_device_architecture</span></a> extensions as described in
<a class="reference internal" href="DeviceIf.html"><span class="std std-doc">DeviceIf.md</span></a>. Additionally, it leverages part of the design for optional
kernel features, as described in <a class="reference internal" href="OptionalDeviceFeatures.html"><span class="std std-doc">OptionalDeviceFeatures.md</span></a>.</p>
<section id="changes-to-the-compiler-driver">
<h2>Changes to the compiler driver<a class="headerlink" href="#changes-to-the-compiler-driver" title="Link to this heading">¶</a></h2>
<p>Using the <code class="docutils literal notranslate"><span class="pre">-fsycl-targets</span></code> options introduced in <a class="reference internal" href="DeviceIf.html"><span class="std std-doc">DeviceIf.md</span></a> and the
configuration file introduced in <a class="reference internal" href="OptionalDeviceFeatures.html"><span class="std std-doc">OptionalDeviceFeatures.md</span></a>, the compiler
driver finds the set of all aspects supported by each specified target. Note
that in this section we refer to aspects as their integral representation as
specified in the device headers rather than by the names specified in the
<a class="reference external" href="https://registry.khronos.org/SYCL/specs/sycl-2020/html/sycl-2020.html#sec:device-aspects">SYCL 2020 specification</a>.</p>
<p>For each target $t$ in <code class="docutils literal notranslate"><span class="pre">-fsycl-targets</span></code>, let $A^{any}_t$ be the set of aspects
supported by any device supporting $t$ and let $A^{all}_t$ be the set of aspects
supported by all devices supporting $t$. These sets are defined as follows:</p>
<ul class="simple">
<li><p>If $t$ has an entry in the configuration file, $A^{all}_t$ is the same as the
<code class="docutils literal notranslate"><span class="pre">aspects</span></code> list in that entry.</p></li>
<li><p>If $t$ does not have an entry in the configuration file, $A^{all}_t$ is empty.</p></li>
<li><p>If $t$ has an entry in the configuration file and the entry has a value
<code class="docutils literal notranslate"><span class="pre">may_support_other_aspects</span></code> set to <code class="docutils literal notranslate"><span class="pre">false</span></code>, $A^{any}_t$ is the same as the
<code class="docutils literal notranslate"><span class="pre">aspects</span></code> list in that entry.</p></li>
<li><p>If $t$ does not have an entry the configuration file or the entry has a value
<code class="docutils literal notranslate"><span class="pre">may_support_other_aspects</span></code> set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, $A^{any}_t$ is the set of all
aspects.</p></li>
</ul>
<p>For example, the target <code class="docutils literal notranslate"><span class="pre">intel_gpu_dg1</span></code> is supported by a specific device (DG1)
and as such would have an entry in the configuration file with <code class="docutils literal notranslate"><span class="pre">aspects</span></code> being
the set of aspects that device supports. Likewise it would have
<code class="docutils literal notranslate"><span class="pre">may_support_other_aspects</span></code> set to <code class="docutils literal notranslate"><span class="pre">false</span></code> as there will be no other devices
supporting this target, meaning there will never be any devices supporting
the target and supporting anything not in <code class="docutils literal notranslate"><span class="pre">aspects</span></code>.  In contrast, the target
<code class="docutils literal notranslate"><span class="pre">nvidia_gpu_sm_80</span></code> is supported by CUDA devices with <code class="docutils literal notranslate"><span class="pre">sm_80</span></code> architecture or
newer, so its entry in the configuration file would have
<code class="docutils literal notranslate"><span class="pre">may_support_other_aspects</span></code> set to <code class="docutils literal notranslate"><span class="pre">true</span></code> to indicate that there could be future
devices that support aspects not in <code class="docutils literal notranslate"><span class="pre">aspects</span></code>, while it is known that all
current and future devices must support the aspects in <code class="docutils literal notranslate"><span class="pre">aspects</span></code>.  Lastly, the
default JIT SPIR-V target (<code class="docutils literal notranslate"><span class="pre">spir64</span></code>) should not have an entry in the
configuration file as it cannot guarantee anything about the devices supporting
the target.</p>
<p>When compiling a SYCL program, where $[t1, t2, \ldots, tn]$ are the $n$ targets
specified in <code class="docutils literal notranslate"><span class="pre">-fsycl-targets</span></code> including any targets implicitly added by the
driver, the driver defines the following macros in both host and device
compilation invocations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__SYCL_ALL_DEVICES_HAVE_</span></code>$aspectName_{i}$<code class="docutils literal notranslate"><span class="pre">__</span></code> as <code class="docutils literal notranslate"><span class="pre">1</span></code> for all $i$ in
${\bigcap}^n_{k=1} A^{all}_{tk}$.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__SYCL_ANY_DEVICE_HAS_ANY_ASPECT__</span></code> as <code class="docutils literal notranslate"><span class="pre">1</span></code> if
${\bigcup}^n_{k=1} A^{any}_{tk}$ is the set of all aspects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__SYCL_ANY_DEVICE_HAS_</span></code>$aspectName_{j}$<code class="docutils literal notranslate"><span class="pre">__</span></code> as <code class="docutils literal notranslate"><span class="pre">1</span></code> for all $j$ in
${\bigcup}^n_{k=1} A^{any}_{tk}$ if <code class="docutils literal notranslate"><span class="pre">__SYCL_ANY_DEVICE_HAS_ANY_ASPECT__</span></code> was not
defined.</p></li>
</ul>
<p>Note that the need for the <code class="docutils literal notranslate"><span class="pre">__SYCL_ANY_DEVICE_HAS_ANY_ASPECT__</span></code> macro is
due to the special case where the driver finds no configuration for a target and
must assume that there exists some device that supports any given aspect. Since
the driver has no way of knowing all possible aspects, we use a catch-all macro
to denote this case instead. This is not needed for $A^{all}_t$ for any target
$t$, as it will always be a finite set of aspects.</p>
</section>
<section id="changes-to-the-device-headers">
<h2>Changes to the device headers<a class="headerlink" href="#changes-to-the-device-headers" title="Link to this heading">¶</a></h2>
<p>Using the macros defined by the driver, the device headers define the traits
together with specializations for each aspect:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">sycl</span><span class="w"> </span><span class="p">{</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="n">aspect</span><span class="w"> </span><span class="n">Aspect</span><span class="o">&gt;</span><span class="w"> </span><span class="n">all_devices_have</span><span class="p">;</span>
<span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">all_devices_have</span><span class="o">&lt;</span><span class="n">aspect</span><span class="o">::</span><span class="n">host</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bool_constant</span><span class="o">&lt;</span><span class="n">__SYCL_ALL_DEVICES_HAVE_host__</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{};</span>
<span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">all_devices_have</span><span class="o">&lt;</span><span class="n">aspect</span><span class="o">::</span><span class="n">cpu</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bool_constant</span><span class="o">&lt;</span><span class="n">__SYCL_ALL_DEVICES_HAVE_cpu__</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{};</span>
<span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">all_devices_have</span><span class="o">&lt;</span><span class="n">aspect</span><span class="o">::</span><span class="n">gpu</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bool_constant</span><span class="o">&lt;</span><span class="n">__SYCL_ALL_DEVICES_HAVE_gpu__</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{};</span>
<span class="p">...</span>

<span class="cp">#ifdef __SYCL_ANY_DEVICE_HAS_ANY_ASPECT__</span>
<span class="c1">// Special case where any_device_has is trivially true.</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="n">aspect</span><span class="w"> </span><span class="n">Aspect</span><span class="o">&gt;</span><span class="w"> </span><span class="n">any_device_has</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="w"> </span><span class="p">{};</span>
<span class="cp">#else</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="n">aspect</span><span class="w"> </span><span class="n">Aspect</span><span class="o">&gt;</span><span class="w"> </span><span class="n">any_device_has</span><span class="p">;</span>
<span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">any_device_has</span><span class="o">&lt;</span><span class="n">aspect</span><span class="o">::</span><span class="n">host</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bool_constant</span><span class="o">&lt;</span><span class="n">__SYCL_ANY_DEVICE_HAS_host__</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{};</span>
<span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">any_device_has</span><span class="o">&lt;</span><span class="n">aspect</span><span class="o">::</span><span class="n">cpu</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bool_constant</span><span class="o">&lt;</span><span class="n">__SYCL_ANY_DEVICE_HAS_cpu__</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{};</span>
<span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">any_device_has</span><span class="o">&lt;</span><span class="n">aspect</span><span class="o">::</span><span class="n">gpu</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bool_constant</span><span class="o">&lt;</span><span class="n">__SYCL_ANY_DEVICE_HAS_gpu__</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{};</span>
<span class="p">...</span>
<span class="cp">#endif </span><span class="c1">// __SYCL_ANY_DEVICE_HAS_ANY_ASPECT__</span>

<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="n">aspect</span><span class="w"> </span><span class="n">Aspect</span><span class="o">&gt;</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">all_devices_have_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_devices_have</span><span class="o">&lt;</span><span class="n">Aspect</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="n">aspect</span><span class="w"> </span><span class="n">Aspect</span><span class="o">&gt;</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">any_device_has_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">any_device_has</span><span class="o">&lt;</span><span class="n">Aspect</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace sycl</span>
</pre></div>
</div>
<p>Note that the driver may not define macros for all aspects as it only knows the
specified subset from the configuration file. As such the device headers will
have to define any undefined <code class="docutils literal notranslate"><span class="pre">__SYCL_ANY_DEVICE_HAS_</span></code>$aspectName_{i}$<code class="docutils literal notranslate"><span class="pre">__</span></code> and
<code class="docutils literal notranslate"><span class="pre">__SYCL_ALL_DEVICES_HAVE_</span></code>$aspectName_{i}$<code class="docutils literal notranslate"><span class="pre">__</span></code> as <code class="docutils literal notranslate"><span class="pre">0</span></code> for all aspect values $i$.</p>
<p>Since the specializations need to be explicitly specified, there is a high
probability of mistakes when new aspects are added. To avoid such mistakes, a
SYCL unit-test uses the <a class="reference download internal" download="" href="../_downloads/c7ac6c3ac2712304316a7bf0da4cc66a/aspects.def"><span class="xref download myst">aspects.def</span></a> file
to generate test cases, ensuring that specializations exist for all aspects:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define __SYCL_ASPECT(ASPECT, ASPECT_VAL)                                          \</span>
<span class="cp">  constexpr bool CheckAnyDeviceHas##ASPECT = any_devices_has_v&lt;aspect::ASPECT&gt;;    \</span>
<span class="cp">  constexpr bool CheckAllDevicesHave##ASPECT = all_devices_have_v&lt;aspect::ASPECT&gt;;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/info/aspects.def&gt;</span>

<span class="cp">#undef __SYCL_ASPECT</span>
</pre></div>
</div>
<p>This relies on the fact that unspecialized variants of <code class="docutils literal notranslate"><span class="pre">any_device_has</span></code> and
<code class="docutils literal notranslate"><span class="pre">all_devices_have</span></code> are undefined.</p>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="NonRelocatableDeviceCode.html">Non-Relocatable Device Code</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="DeviceConfigFile.html">Implementation Design for Device Configuration File</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Intel Corporation.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>