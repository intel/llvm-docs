<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>SYCL Native CPU &#8212; oneAPI DPC++ Compiler  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=dfa0e015" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Command-Graph Extension" href="CommandGraph.html" />
    <link rel="prev" title="Propagation of optimization levels used by front-end compiler to backend" href="PropagateCompilerFlagsToRuntime.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>oneAPI DPC++ Compiler  documentation</span></a></h1>
        <h2 class="heading"><span>SYCL Native CPU</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="PropagateCompilerFlagsToRuntime.html">Propagation of optimization levels used by front-end compiler to backend</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="CommandGraph.html">Command-Graph Extension</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="sycl-native-cpu">
<h1>SYCL Native CPU<a class="headerlink" href="#sycl-native-cpu" title="Link to this heading">¶</a></h1>
<p>The SYCL Native CPU flow aims at treating the host CPU as a “first class citizen”, providing a SYCL implementation that targets CPUs of various different architectures, with no other dependencies than DPC++ itself, while bringing performances comparable to state-of-the-art CPU backends.</p>
</section>
<section id="compiler-and-runtime-options">
<h1>Compiler and runtime options<a class="headerlink" href="#compiler-and-runtime-options" title="Link to this heading">¶</a></h1>
<p>The SYCL Native CPU flow is enabled by setting <code class="docutils literal notranslate"><span class="pre">native_cpu</span></code> as a <code class="docutils literal notranslate"><span class="pre">sycl-target</span></code> (please note that currently doing so overrides any other SYCL target specified in the compiler invocation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">clang</span><span class="o">++</span> <span class="o">-</span><span class="n">fsycl</span> <span class="o">-</span><span class="n">fsycl</span><span class="o">-</span><span class="n">targets</span><span class="o">=</span><span class="n">native_cpu</span> <span class="o">&lt;</span><span class="nb">input</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">o</span> <span class="o">&lt;</span><span class="n">output</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This will perform automatically all the compilation stages. It is also possible to manually perform all the necessary compiler invocations, this is more verbose but allows the user to use an arbitrary host compiler for the second compilation stage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#device compiler</span>
<span class="n">clang</span><span class="o">++</span> <span class="o">-</span><span class="n">fsycl</span><span class="o">-</span><span class="n">device</span><span class="o">-</span><span class="n">only</span> <span class="o">-</span><span class="n">fsycl</span><span class="o">-</span><span class="n">targets</span><span class="o">=</span><span class="n">native_cpu</span> <span class="o">-</span><span class="n">Xclang</span> <span class="o">-</span><span class="n">fsycl</span><span class="o">-</span><span class="nb">int</span><span class="o">-</span><span class="n">header</span><span class="o">=&lt;</span><span class="n">integration</span><span class="o">-</span><span class="n">header</span><span class="o">&gt;</span> \
  <span class="o">-</span><span class="n">D</span> <span class="n">__SYCL_NATIVE_CPU__</span> \
  <span class="o">-</span><span class="n">Xclang</span> <span class="o">-</span><span class="n">fsycl</span><span class="o">-</span><span class="nb">int</span><span class="o">-</span><span class="n">footer</span><span class="o">=&lt;</span><span class="n">integration</span><span class="o">-</span><span class="n">footer</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nb">input</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">o</span> <span class="o">&lt;</span><span class="n">device</span><span class="o">-</span><span class="n">ir</span><span class="o">&gt;</span>
<span class="c1">#host compiler</span>
<span class="n">clang</span><span class="o">++</span> <span class="o">-</span><span class="n">fsycl</span><span class="o">-</span><span class="ow">is</span><span class="o">-</span><span class="n">host</span> <span class="o">-</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">integration</span><span class="o">-</span><span class="n">header</span><span class="o">&gt;</span> \
  <span class="o">-</span><span class="n">D</span> <span class="n">__SYCL_NATIVE_CPU__</span> \
  <span class="o">-</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">integration</span><span class="o">-</span><span class="n">footer</span><span class="o">&gt;</span> \
  <span class="o">&lt;</span><span class="n">intput</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="o">&lt;</span><span class="n">host</span><span class="o">-</span><span class="n">o</span><span class="o">&gt;</span>
<span class="c1">#compile device IR</span>
<span class="n">clang</span><span class="o">++</span> <span class="o">&lt;</span><span class="n">device</span><span class="o">-</span><span class="n">ir</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">o</span> <span class="o">&lt;</span><span class="n">device</span><span class="o">-</span><span class="n">o</span><span class="o">&gt;</span>
<span class="c1">#link</span>
<span class="n">clang</span><span class="o">++</span> <span class="o">-</span><span class="n">L</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">-</span><span class="n">lib</span><span class="o">-</span><span class="n">path</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">lsycl</span> <span class="o">&lt;</span><span class="n">device</span><span class="o">-</span><span class="n">o</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">host</span><span class="o">-</span><span class="n">o</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">o</span> <span class="o">&lt;</span><span class="n">output</span><span class="o">&gt;</span>
</pre></div>
</div>
<section id="configuring-dpc-with-sycl-native-cpu">
<h2>Configuring DPC++ with SYCL Native CPU<a class="headerlink" href="#configuring-dpc-with-sycl-native-cpu" title="Link to this heading">¶</a></h2>
<p>SYCL Native CPU needs to be enabled explictly when configuring DPC++, using <code class="docutils literal notranslate"><span class="pre">--native_cpu</span></code>, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">buildbot</span><span class="o">/</span><span class="n">configure</span><span class="o">.</span><span class="n">py</span> \
  <span class="o">--</span><span class="n">native_cpu</span>
<span class="c1"># other options here</span>
</pre></div>
</div>
<section id="libclc-target-triples">
<h3>libclc target triples<a class="headerlink" href="#libclc-target-triples" title="Link to this heading">¶</a></h3>
<p>SYCL Native CPU uses <a class="reference external" href="https://github.com/intel/llvm/tree/sycl/libclc">libclc</a> to implement many SPIRV builtins. When Native CPU is enabled, the default target triple for libclc will be <code class="docutils literal notranslate"><span class="pre">LLVM_TARGET_TRIPLE</span></code> (same as the default target triple used by <code class="docutils literal notranslate"><span class="pre">clang</span></code>). This can be overridden by setting the <code class="docutils literal notranslate"><span class="pre">--native-cpu-libclc-targets</span></code> option in <code class="docutils literal notranslate"><span class="pre">configure.py</span></code>.</p>
</section>
<section id="oneapi-construction-kit">
<h3>oneAPI Construction Kit<a class="headerlink" href="#oneapi-construction-kit" title="Link to this heading">¶</a></h3>
<p>SYCL Native CPU uses the <a class="reference external" href="https://github.com/codeplaysoftware/oneapi-construction-kit">oneAPI Construction Kit</a> (OCK) in order to support some core SYCL functionalities and improve performances, the OCK is fetched by default when SYCL Native CPU is enabled, and can optionally be disabled using the <code class="docutils literal notranslate"><span class="pre">NATIVECPU_USE_OCK</span></code> CMake variable (please note that disabling the OCK will result in limited functionalities and performances on the SYCL Native CPU backend):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">buildbot</span><span class="o">/</span><span class="n">configure</span><span class="o">.</span><span class="n">py</span> \
  <span class="o">--</span><span class="n">native_cpu</span> \
  <span class="o">--</span><span class="n">cmake</span><span class="o">-</span><span class="n">opt</span><span class="o">=-</span><span class="n">DNATIVECPU_USE_OCK</span><span class="o">=</span><span class="n">Off</span>
</pre></div>
</div>
<p>By default the oneAPI Construction Kit is pulled at the project’s configure time using CMake <code class="docutils literal notranslate"><span class="pre">FetchContent</span></code>. This behaviour can be overridden by setting <code class="docutils literal notranslate"><span class="pre">NATIVECPU_OCK_USE_FETCHCONTENT=Off</span></code> and <code class="docutils literal notranslate"><span class="pre">OCK_SOURCE_DIR=&lt;path&gt;</span></code>
in order to use a local checkout of the oneAPI Construction Kit. The CMake variables <code class="docutils literal notranslate"><span class="pre">OCK_GIT_TAG</span></code> and <code class="docutils literal notranslate"><span class="pre">OCK_GIT_REPO</span></code> can be used to override the default git tag and repository used by <code class="docutils literal notranslate"><span class="pre">FetchContent</span></code>.</p>
<p>The SYCL Native CPU device needs to be selected at runtime by setting the environment variable <code class="docutils literal notranslate"><span class="pre">ONEAPI_DEVICE_SELECTOR=native_cpu:cpu</span></code>.</p>
</section>
</section>
</section>
<section id="supported-features-and-current-limitations">
<h1>Supported features and current limitations<a class="headerlink" href="#supported-features-and-current-limitations" title="Link to this heading">¶</a></h1>
<p>The SYCL Native CPU flow is still WIP, not optimized and several core SYCL features are currently unsupported. Currently <code class="docutils literal notranslate"><span class="pre">barriers</span></code> are supported only when the oneAPI Construction Kit integration is enabled, several math builtins are not supported and attempting to use those will most likely fail with an <code class="docutils literal notranslate"><span class="pre">undefined</span> <span class="pre">reference</span></code> error at link time. Examples of supported applications can be found in the <a class="reference external" href="https://github.com/intel/llvm/blob/sycl/sycl/test/native_cpu">runtime tests</a>.</p>
<p>To execute the <code class="docutils literal notranslate"><span class="pre">e2e</span></code> tests on SYCL Native CPU, configure the test suite with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># make sure that DPC++ is in your $PATH and your environment is configured for DPC++</span>

<span class="nb">cd</span><span class="w"> </span>sycl/test-e2e
cmake<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-G<span class="w"> </span>Ninja<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-B<span class="w"> </span>build<span class="w"> </span>-S<span class="w"> </span>.<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-DCMAKE_CXX_COMPILER<span class="o">=</span>clang++<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-DSYCL_TEST_E2E_TARGETS<span class="o">=</span><span class="s2">&quot;native_cpu:cpu&quot;</span><span class="w"> </span>
</pre></div>
</div>
<p>Note that a number of <code class="docutils literal notranslate"><span class="pre">e2e</span></code> tests are currently still failing.</p>
</section>
<section id="vectorization">
<h1>Vectorization<a class="headerlink" href="#vectorization" title="Link to this heading">¶</a></h1>
<p>With the integration of the OneAPI Construction Kit, the SYCL Native CPU target
also gained support for Whole Function Vectorization.\
Whole Function Vectorization is enabled by default, and can be controlled through these compiler options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-mllvm</span> <span class="pre">-sycl-native-cpu-no-vecz</span></code>: disable Whole Function Vectorization.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-mllvm</span> <span class="pre">-sycl-native-cpu-vecz-width</span></code>: sets the vector width to the specified value, defaults to 8.</p></li>
</ul>
<p>For more details on how the Whole Function Vectorizer is integrated for SYCL Native CPU, refer to the [Technical details[(#technical-details) section.</p>
<section id="ongoing-work">
<h2>Ongoing work<a class="headerlink" href="#ongoing-work" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Complete support for remaining SYCL features, including but not limited to</p>
<ul>
<li><p>math and other builtins</p></li>
</ul>
</li>
<li><p>Subgroup support</p></li>
<li><p>Performance optimizations</p></li>
</ul>
<section id="please-note-that-windows-support-is-temporarily-disabled-due-to-some-implementation-details-it-will-be-reinstantiated-soon">
<h3>Please note that Windows support is temporarily disabled due to some implementation details, it will be reinstantiated soon.<a class="headerlink" href="#please-note-that-windows-support-is-temporarily-disabled-due-to-some-implementation-details-it-will-be-reinstantiated-soon" title="Link to this heading">¶</a></h3>
</section>
</section>
</section>
<section id="technical-details">
<h1>Technical details<a class="headerlink" href="#technical-details" title="Link to this heading">¶</a></h1>
<p>The following section gives a brief overview of how a simple SYCL application is compiled for the SYCL Native CPU target. Consider the following SYCL sample, which performs vector addition using USM:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">cl</span><span class="o">::</span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">deviceQueue</span><span class="p">;</span>
<span class="w">  </span><span class="n">cl</span><span class="o">::</span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">numOfItems</span><span class="p">{</span><span class="n">N</span><span class="p">};</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">a_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">malloc_device</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">deviceQueue</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">b_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">malloc_device</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">deviceQueue</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">c_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">malloc_device</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">deviceQueue</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// copy mem to device, omitted</span>
<span class="w">  </span><span class="n">deviceQueue</span>
<span class="w">      </span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">cl</span><span class="o">::</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cgh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">kern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">cl</span><span class="o">::</span><span class="n">sycl</span><span class="o">::</span><span class="n">id</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">wiID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">c_ptr</span><span class="p">[</span><span class="n">wiID</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_ptr</span><span class="p">[</span><span class="n">wiID</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b_ptr</span><span class="p">[</span><span class="n">wiID</span><span class="p">];</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">cgh</span><span class="p">.</span><span class="n">parallel_for</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">Sample</span><span class="o">&gt;</span><span class="p">(</span><span class="n">numOfItems</span><span class="p">,</span><span class="w"> </span><span class="n">kern</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
<span class="w">  </span><span class="n">deviceQueue</span><span class="p">.</span><span class="n">memcpy</span><span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">c_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</pre></div>
</div>
<p>The extracted device code produces the following LLVM-IR:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="k">weak_odr</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="k">spir_kernel</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_Z6Sample</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">%_arg_c_ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">%_arg_a_ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv">%_arg_b_ptr</span><span class="p">)</span><span class="w"> </span><span class="k">local_unnamed_addr</span><span class="w"> </span><span class="vg">#1</span><span class="w"> </span><span class="k">comdat</span><span class="w"> </span><span class="nv">!srcloc</span><span class="w"> </span><span class="nv nv-Anonymous">!74</span><span class="w"> </span><span class="nv">!kernel_arg_buffer_location</span><span class="w"> </span><span class="nv nv-Anonymous">!75</span><span class="w"> </span><span class="nv">!kernel_arg_type</span><span class="w"> </span><span class="nv nv-Anonymous">!76</span><span class="w"> </span><span class="nv">!sycl_fixed_targets</span><span class="w"> </span><span class="nv nv-Anonymous">!49</span><span class="w"> </span><span class="nv">!sycl_kernel_omit_args</span><span class="w"> </span><span class="nv nv-Anonymous">!77</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@__spirv_BuiltInGlobalInvocationId</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">32</span><span class="p">,</span><span class="w"> </span><span class="nv">!noalias</span><span class="w"> </span><span class="nv nv-Anonymous">!78</span>
<span class="w">  </span><span class="nv">%arrayidx.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%_arg_a_ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span>
<span class="w">  </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%arrayidx.i</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!tbaa</span><span class="w"> </span><span class="nv nv-Anonymous">!72</span>
<span class="w">  </span><span class="nv">%arrayidx4.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%_arg_b_ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span>
<span class="w">  </span><span class="nv nv-Anonymous">%2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%arrayidx4.i</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!tbaa</span><span class="w"> </span><span class="nv nv-Anonymous">!72</span>
<span class="w">  </span><span class="nv">%add.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span>
<span class="w">  </span><span class="nv">%cmp.i8.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">ult</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="m">2147483648</span>
<span class="w">  </span><span class="k">tail</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.assume</span><span class="p">(</span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp.i8.i</span><span class="p">)</span>
<span class="w">  </span><span class="nv">%arrayidx6.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%_arg_c_ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%add.i</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%arrayidx6.i</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!tbaa</span><span class="w"> </span><span class="nv nv-Anonymous">!72</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For the SYCL Native CPU target, the device compiler is in charge of materializing the SPIRV builtins (such as <code class="docutils literal notranslate"><span class="pre">&#64;__spirv_BuiltInGlobalInvocationId</span></code>), so that they can be correctly updated by the runtime when executing the kernel. This is performed by the <a class="reference external" href="https://github.com/intel/llvm/blob/sycl/llvm/lib/SYCLLowerIR/PrepareSYCLNativeCPU.cpp">PrepareSYCLNativeCPU pass</a>.
The PrepareSYCLNativeCPUPass also emits a <code class="docutils literal notranslate"><span class="pre">subhandler</span></code> function, which receives the kernel arguments from the SYCL runtime (packed in a vector), unpacks them, and forwards only the used ones to the actual kernel.</p>
<section id="preparesyclnativecpu-pass">
<h2>PrepareSYCLNativeCPU Pass<a class="headerlink" href="#preparesyclnativecpu-pass" title="Link to this heading">¶</a></h2>
<p>This pass will add a pointer to a <code class="docutils literal notranslate"><span class="pre">nativecpu_state</span></code> struct as kernel argument to all the kernel functions, and it will replace all the uses of SPIRV builtins with the return value of appropriately defined functions, which will read the requested information from the <code class="docutils literal notranslate"><span class="pre">__nativecpu_state</span></code> struct. The <code class="docutils literal notranslate"><span class="pre">__nativecpu_state</span></code> struct and the builtin functions are defined in <a class="reference external" href="https://github.com/intel/llvm/blob/sycl/sycl/include/sycl/detail/native_cpu.hpp">native_cpu.hpp</a>.</p>
<p>The resulting IR is:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="k">weak</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_Z6Sample.NativeCPUKernel</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="p">)</span><span class="w"> </span><span class="k">local_unnamed_addr</span><span class="w"> </span><span class="vg">#3</span><span class="w"> </span><span class="nv">!srcloc</span><span class="w"> </span><span class="nv nv-Anonymous">!74</span><span class="w"> </span><span class="nv">!kernel_arg_buffer_location</span><span class="w"> </span><span class="nv nv-Anonymous">!75</span><span class="w"> </span><span class="nv">!kernel_arg_type</span><span class="w"> </span><span class="nv nv-Anonymous">!76</span><span class="w"> </span><span class="nv">!sycl_fixed_targets</span><span class="w"> </span><span class="nv nv-Anonymous">!49</span><span class="w"> </span><span class="nv">!sycl_kernel_omit_args</span><span class="w"> </span><span class="nv nv-Anonymous">!77</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%ncpu_builtin</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@_Z13get_global_idmP15nativecpu_state</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="p">)</span>
<span class="w">  </span><span class="nv nv-Anonymous">%4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%ncpu_builtin</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">32</span><span class="p">,</span><span class="w"> </span><span class="nv">!noalias</span><span class="w"> </span><span class="nv nv-Anonymous">!78</span>
<span class="w">  </span><span class="nv">%arrayidx.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span>
<span class="w">  </span><span class="nv nv-Anonymous">%5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%arrayidx.i</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!tbaa</span><span class="w"> </span><span class="nv nv-Anonymous">!72</span>
<span class="w">  </span><span class="nv">%arrayidx4.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span>
<span class="w">  </span><span class="nv nv-Anonymous">%6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%arrayidx4.i</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!tbaa</span><span class="w"> </span><span class="nv nv-Anonymous">!72</span>
<span class="w">  </span><span class="nv">%add.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%6</span>
<span class="w">  </span><span class="nv">%cmp.i8.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">ult</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span><span class="p">,</span><span class="w"> </span><span class="m">2147483648</span>
<span class="w">  </span><span class="k">tail</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.assume</span><span class="p">(</span><span class="kt">i1</span><span class="w"> </span><span class="nv">%cmp.i8.i</span><span class="p">)</span>
<span class="w">  </span><span class="nv">%arrayidx6.i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%add.i</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%arrayidx6.i</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!tbaa</span><span class="w"> </span><span class="nv nv-Anonymous">!72</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This pass will also set the correct calling convention for the target, and handle calling convention-related function attributes, allowing to call the kernel from the runtime.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">subhandler</span></code> for the SYCL Native CPU kernel looks like:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="k">weak</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_Z6Sample</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">)</span><span class="w"> </span><span class="vg">#4</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv nv-Anonymous">%2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="nv nv-Anonymous">%3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv nv-Anonymous">%4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">3</span>
<span class="w">  </span><span class="nv nv-Anonymous">%5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%4</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv nv-Anonymous">%6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="nv nv-Anonymous">%7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%6</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv nv-Anonymous">%8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">7</span>
<span class="w">  </span><span class="nv nv-Anonymous">%9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%8</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_ZTS10SimpleVaddIiE.NativeCPUKernel</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%7</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%9</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">)</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see, the <code class="docutils literal notranslate"><span class="pre">subhandler</span></code> steals the kernel’s function name, and receives two pointer arguments: the first one points to the kernel arguments from the SYCL runtime, and the second one to the <code class="docutils literal notranslate"><span class="pre">__nativecpu_state</span></code> struct.</p>
</section>
<section id="handling-barriers">
<h2>Handling barriers<a class="headerlink" href="#handling-barriers" title="Link to this heading">¶</a></h2>
<p>On SYCL Native CPU, calls to <code class="docutils literal notranslate"><span class="pre">__spirv_ControlBarrier</span></code> are handled using the <code class="docutils literal notranslate"><span class="pre">WorkItemLoopsPass</span></code> from the oneAPI Construction Kit. This pass handles barriers by splitting the kernel between calls calls to <code class="docutils literal notranslate"><span class="pre">__spirv_ControlBarrier</span></code>, and creating a wrapper that runs the subkernels over the local range. In order to correctly interface to the oneAPI Construction Kit pass pipeline, SPIRV builtins are converted to <code class="docutils literal notranslate"><span class="pre">mux</span></code> builtins (used by the OCK) by the <code class="docutils literal notranslate"><span class="pre">ConvertToMuxBuiltinsSYCLNativeCPUPass</span></code>.</p>
</section>
<section id="id1">
<h2>Vectorization<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p>The OneAPI Construction Kit’s Whole Function Vectorizer is executed as an LLVM Pass. Considering the following input function:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@SimpleVadd</span><span class="p">(</span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nv nv-Anonymous">%5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="vg">@_Z13get_global_idj</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="w">  </span><span class="nv nv-Anonymous">%6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span>
<span class="w">  </span><span class="nv nv-Anonymous">%7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%6</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="nv nv-Anonymous">%8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span>
<span class="w">  </span><span class="nv nv-Anonymous">%9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%8</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="nv nv-Anonymous">%10</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%9</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%7</span>
<span class="w">  </span><span class="nv nv-Anonymous">%11</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%10</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%11</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With a vector width of 8, the vectorizer will produce:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@__vecz_v8_SimpleVadd</span><span class="p">(</span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*)</span><span class="w"> </span><span class="nv">!codeplay_ca_vecz.derived</span><span class="w"> </span><span class="nv nv-Anonymous">!2</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nv nv-Anonymous">%5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="vg">@_Z13get_global_idj</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="w">  </span><span class="nv nv-Anonymous">%6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span>
<span class="w">  </span><span class="nv nv-Anonymous">%7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="p">&lt;</span><span class="m">8</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%6</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="nv nv-Anonymous">%8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span>
<span class="w">  </span><span class="nv nv-Anonymous">%9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="p">&lt;</span><span class="m">8</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%8</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="nv nv-Anonymous">%10</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="p">&lt;</span><span class="m">8</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%9</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">%7</span>
<span class="w">  </span><span class="nv nv-Anonymous">%11</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%5</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="p">&lt;</span><span class="m">8</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv nv-Anonymous">%12</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%11</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span>
<span class="p">}</span>
<span class="nv nv-Anonymous">!1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="kt">i32</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">}</span>
<span class="nv nv-Anonymous">!2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="nv nv-Anonymous">!1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@_ZTSN4sycl3_V16detail19__pf_kernel_wrapperI10SimpleVaddEE</span><span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">__vecz_v8_SimpleVadd</span></code> function is the vectorized version of the original function. It receives arguments of the same type,
and has the <code class="docutils literal notranslate"><span class="pre">codeplay_ca_vecz.derived</span></code> metadata node attached. The metadata node contains information about the vectorization width,
and points to the original version of the function. This information is used later in the pass pipeline by the <code class="docutils literal notranslate"><span class="pre">WorkItemLoopsPass</span></code>,
which will account for the vectorization when creating the Work Item Loops, and use the original version of the function to add
peeling loops.</p>
</section>
<section id="kernel-registration">
<h2>Kernel registration<a class="headerlink" href="#kernel-registration" title="Link to this heading">¶</a></h2>
<p>In order to register the SYCL Native CPU kernels to the SYCL runtime, we applied a small change to the <code class="docutils literal notranslate"><span class="pre">clang-offload-wrapper</span></code> tool: normally, the <code class="docutils literal notranslate"><span class="pre">clang-offload-wrapper</span></code> bundles the offload binary in an LLVM-IR module. Instead of bundling the device code, for the SYCL Native CPU target we insert an array of function pointers to the <code class="docutils literal notranslate"><span class="pre">subhandler</span></code>s, and the <code class="docutils literal notranslate"><span class="pre">pi_device_binary_struct::BinaryStart</span></code> and <code class="docutils literal notranslate"><span class="pre">pi_device_binary_struct::BinaryEnd</span></code> fields, which normally point to the begin and end addresses of the offload binary, now point to the begin and end of the array.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">-------------------------------------------------------</span>
 <span class="o">|</span> <span class="s2">&quot;_Z6Sample&quot;</span>   <span class="o">|</span> <span class="n">other</span> <span class="n">entries</span>  <span class="o">|</span>  <span class="s2">&quot;__nativecpu_end&quot;</span> <span class="o">|</span>
 <span class="o">|</span> <span class="o">&amp;</span><span class="n">_Z6Sample</span>    <span class="o">|</span>                <span class="o">|</span>  <span class="n">nullptr</span>           <span class="o">|</span>
 <span class="o">-------------------------------------------------------</span>
        <span class="o">^</span>                                   <span class="o">^</span>    
        <span class="o">|</span>                                   <span class="o">|</span>
    <span class="n">BinaryStart</span>                         <span class="n">BinaryEnd</span>  
</pre></div>
</div>
<p>Each entry in the array contains the kernel name as a string, and a pointer to the <code class="docutils literal notranslate"><span class="pre">subhandler</span></code> function declaration. Since the subhandler’s signature has always the same arguments (two pointers in LLVM-IR), the <code class="docutils literal notranslate"><span class="pre">clang-offload-wrapper</span></code> can emit the function declarations given just the function names contained in the <code class="docutils literal notranslate"><span class="pre">.table</span></code> file emitted by <code class="docutils literal notranslate"><span class="pre">sycl-post-link</span></code>. The symbols are then resolved by the system’s linker, which receives both the output from the offload wrapper and the lowered device module.</p>
</section>
<section id="kernel-lowering-and-execution">
<h2>Kernel lowering and execution<a class="headerlink" href="#kernel-lowering-and-execution" title="Link to this heading">¶</a></h2>
<p>The information produced by the device compiler is then employed to correctly lower the kernel LLVM-IR module to the target ISA (this is performed by the driver when <code class="docutils literal notranslate"><span class="pre">-fsycl-targets=native_cpu</span></code> is set). The object file containing the kernel code is linked with the host object file (and libsycl and any other needed library) and the final executable is run using the SYCL Native CPU UR Adapter, defined in <a class="reference external" href="https://github.com/oneapi-src/unified-runtime/tree/adapters/source/adapters/native_cpu">the Unified Runtime repo</a>.</p>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="PropagateCompilerFlagsToRuntime.html">Propagation of optimization levels used by front-end compiler to backend</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="CommandGraph.html">Command-Graph Extension</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Intel Corporation.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>